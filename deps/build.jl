using BinaryProvider, Compat, Compat.Libdl

# Parse some basic command-line arguments
const verbose = "--verbose" in ARGS
const prefix = Prefix(get([a for a in ARGS if a != "--verbose"], 1, joinpath(@__DIR__, "usr")))
products = Product[
    LibraryProduct(prefix, String["libmbedcrypto"], :libmbedcrypto),
    LibraryProduct(prefix, String["libmbedtls"], :libmbedtls),
    LibraryProduct(prefix, String["libmbedx509"], :libmbedx509),
]

const juliaprefix = joinpath(Compat.Sys.BINDIR, "..")

juliaproducts = Product[
    LibraryProduct(juliaprefix, "libmbedtls", :libmbedtls)
    LibraryProduct(juliaprefix, "libmbedcrypto", :libmbedcrypto)
    LibraryProduct(juliaprefix, "libmbedx509", :libmbedx509)
]

# Download binaries from hosted location
bin_prefix = "https://github.com/JuliaWeb/MbedTLSBuilder/releases/download/v0.7"

# Listing of files generated by BinaryBuilder:
download_info = Dict(
    BinaryProvider.Linux(:aarch64, :glibc, :blank_abi) => ("$bin_prefix/MbedTLS.aarch64-linux-gnu.tar.gz", "5b87aa0b7e37e45cdbb00fda206a1a18728226c7b9b7f8de64d1e4f11c759756"),
    BinaryProvider.UnknownPlatform() => ("$bin_prefix/MbedTLS.arm-linux-gnueabihf.tar.gz", "ad0892f1acdb21c4bed37b2890263e1df5bfb315145c8b076c769491e8e1afb7"),
    BinaryProvider.Linux(:i686, :glibc, :blank_abi) => ("$bin_prefix/MbedTLS.i686-linux-gnu.tar.gz", "1725f14d7877d80fed9590c14fc93ba81b9eab1d3980360f3ea74eea41b0203c"),
    BinaryProvider.Windows(:i686, :blank_libc, :blank_abi) => ("$bin_prefix/MbedTLS.i686-w64-mingw32.tar.gz", "f920a05fcd94222c3331e3df95fe9618b14be9392e72e2669b83dfcc7f1912fa"),
    BinaryProvider.Linux(:powerpc64le, :glibc, :blank_abi) => ("$bin_prefix/MbedTLS.powerpc64le-linux-gnu.tar.gz", "2a06669ff563310bc8249b94122e2f5d4ff3851b06b9d000b48fd65e78d8b046"),
    BinaryProvider.MacOS(:x86_64, :blank_libc, :blank_abi) => ("$bin_prefix/MbedTLS.x86_64-apple-darwin14.tar.gz", "7115f00a58752123a2d471071497edde84f6f5fb1dee900021188e8b24a7881e"),
    BinaryProvider.Linux(:x86_64, :glibc, :blank_abi) => ("$bin_prefix/MbedTLS.x86_64-linux-gnu.tar.gz", "b1825d93bb6309597a7c66c7a230121b5a01944d78e2fae1b561daecb5d10a96"),
    BinaryProvider.Windows(:x86_64, :blank_libc, :blank_abi) => ("$bin_prefix/MbedTLS.x86_64-w64-mingw32.tar.gz", "7d3b7b0c239a245b3a78f0ddc0a598be0c4c0dea5d8c4f98ccfb67a4c4fc4429"),
)

# First, check to see if we're all satisfied
if any(!satisfied(p; verbose=verbose) for p in products) || get(ENV, "MBEDTLS_JL_FORCE_BUILD", "false") != "true"
    if haskey(download_info, platform_key()) && get(ENV, "MBEDTLS_JL_FORCE_BUILD", "false") != "true" && !haskey(ENV, "USE_GPL_MBEDTLS")
        # Download and install binaries
        url, tarball_hash = download_info[platform_key()]
        install(url, tarball_hash; prefix=prefix, force=true, verbose=verbose)
        Compat.@info "using prebuilt binaries"
        write_deps_file(joinpath(@__DIR__, "deps.jl"), products)
    elseif all(satisfied(p; verbose=verbose) for p in juliaproducts) && get(ENV, "MBEDTLS_JL_FORCE_BUILD", "false") != "true"
        Compat.@info "using julia-shipped binaries"
        products = juliaproducts
    else
        Compat.@info "attempting source build"
        VERSION = "2.7.0"
        url, hash = haskey(ENV, "USE_GPL_MBEDTLS") ?
            ("https://tls.mbed.org/download/mbedtls-$VERSION-gpl.tgz", "2c6fe289b4b50bf67b4839e81b07fcf52a19f5129d0241d2aa4d49cb1ef11e4f") :
            ("https://tls.mbed.org/download/mbedtls-$VERSION-apache.tgz", "aeb66d6cd43aa1c79c145d15845c655627a7fc30d624148aaafbb6c36d7f55ef")
        download_verify(url, hash, joinpath(@__DIR__, "mbedtls.tgz"), force=true, verbose=true)
        unpack(joinpath(@__DIR__, "mbedtls.tgz"), @__DIR__; verbose=true)
        withenv("VERSION"=>VERSION) do
            run(Cmd(`./build.sh`, dir=@__DIR__))
        end
        if any(!satisfied(p; verbose=verbose) for p in products)
            error("attempted to build mbedtls shared libraries, but they couldn't be located (deps/usr/lib)")
        end
    end
end

write_deps_file(joinpath(@__DIR__, "deps.jl"), products)
